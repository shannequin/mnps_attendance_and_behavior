---
title: "data_exploration"
output: html_document
---


```{r}
library(tidyverse)
library(janitor) # Cleans names of a data.frame
library(scales)
```


# Explore district profile
```{r}
# Read data
district_profile_df <- read_csv("../data/district-profile-2024-2025.csv")

# View summary
district_profile_df |> summary()
```


```{r}
# Convert district_no to factor
district_profile_df <- district_profile_df |> 
    mutate(district_no = factor(district_no))
```


```{r}
# Verify unique district numbers
district_profile_df |> distinct(district_no)
```


```{r}
# district_no 0 State of Tennessee
district_profile_df |> filter(district_no == 0)
```


```{r}
# Percentage columns contain non-numeric values: "Less than 1%", "Fewer than 10 students", "More than 99%"
district_profile_df |> distinct(hawaiian_pacisld_pct) |> arrange(hawaiian_pacisld_pct)
```


# Explore school profile
```{r}
# Read data
school_profile_df <- read_csv("../data/school-profile-2024-2025.csv")

# View summary
school_profile_df |> summary()
```


```{r}
# Convert district_no and school_no to factor
school_profile_df <- school_profile_df |> 
    mutate(district_no = factor(district_no)) |> 
    mutate(school_no = factor(school_no))
```


```{r}
# Percentage columns contain non-numeric values: "Less than 5%", "Fewer than 10 students", "More than 95%"
school_profile_df |> distinct(white_pct) |> arrange(desc(white_pct))
```


# Explore district discipline
```{r}
# Read data
district_discipline_df <- read_csv("../data/discipline-district-2425.csv")

# View summary
district_discipline_df |> summary()
```


```{r}
# Convert District to factor
district_discipline_df <- district_discipline_df |> 
    mutate(District = factor(District))
```


```{r}
# Count and percent columns contain non-numeric values: "Less than 1%", "Fewer than 10 students"
district_discipline_df |> distinct(`Students Iss`) |> arrange(desc(`Students Iss`))
```


# Explore school discipline
```{r}
# Read data
school_discipline_df <- read_csv("../data/discipline-school-2425.csv")

# View summary
school_discipline_df |> summary()
```


```{r}
# Convert District and School to factor
school_discipline_df <- school_discipline_df |> 
    mutate(District = factor(District)) |> 
    mutate(School = factor(School))
```


```{r}
# Does not contain district 0 for State of TN
# Duplicates in School and School Name (separate districts)
# Count and percent columns contain non-numeric values: "Fewer than 10 students", "Less than 1%", "Less than 5%"
school_discipline_df |> distinct(`Percent Disciplined`) |> arrange(desc(`Percent Disciplined`))
```


# Explore state chronic absenteeism suppressed
```{r}
# Read data
state_chronic_absenteeism_suppressed_df <- read_csv("../data/state_chronic_absenteeism_suppressed_2025.csv")

# View summary
state_chronic_absenteeism_suppressed_df |> summary()
```


```{r}
# No non-numeric values in count or percentage columns
state_chronic_absenteeism_suppressed_df |> distinct(n_chronically_absent) |> arrange(n_chronically_absent)
```


# Explore district chronic absenteeism suppressed
```{r}
# Read data
district_chronic_absenteeism_suppressed_df <- read_csv("../data/district_chronic_absenteeism_suppressed_2025.csv")

# View summary
district_chronic_absenteeism_suppressed_df |> summary()
```


```{r}
# Convert system to factor
district_chronic_absenteeism_suppressed_df <- district_chronic_absenteeism_suppressed_df |> 
    mutate(system = factor(system))
```


```{r}
# I think "system" is the same as "district"
# n_chronically_absent and pct_chronically_absent contains non-numeric values: "<10 students", "<1%"
district_chronic_absenteeism_suppressed_df |> distinct(pct_chronically_absent) |> arrange(desc(pct_chronically_absent))
```


# Explore school chronic absenteeism suppressed
```{r}
# Read data
school_chronic_absenteeism_suppressed_df <- read_csv("../data/school_chronic_absenteeism_suppressed_2025.csv")

# View summary
school_chronic_absenteeism_suppressed_df |> summary()
```


```{r}
# Convert system and school to factor
school_chronic_absenteeism_suppressed_df <- school_chronic_absenteeism_suppressed_df |> 
    mutate(system = factor(system)) |> 
    mutate(system = factor(school))
```


```{r}
# I think "system" is the same as "district"
# n_chronically_absent contains non-numeric values: "<10 students", "<5%", ">95%"
school_chronic_absenteeism_suppressed_df |> distinct(n_chronically_absent) |> arrange(desc(n_chronically_absent))
```


# Explore MNPS enrollment data
```{r}
# Read data
mnps_enrollment_df <- read_csv("../data/MNPS Enrollment Data 031025.csv")

# View summary
mnps_enrollment_df |> summary()
```


```{r}
# Convert School ID and Zip Code to factor
mnps_enrollment_df <- mnps_enrollment_df |> 
    mutate(`School ID` = factor(`School ID`)) |> 
    mutate(`Zip Code` = factor(`Zip Code`))
```


```{r}
# Ignore `School Level` value "Adult"? Verify 149 districts
mnps_enrollment_df |> distinct(`School Level`) |> arrange(desc(`School Level`))
```


```{r}
# Grade columns contains non-numeric values: "%", "< 10", "< 5%", "> 95%"
mnps_enrollment_df |> distinct(`Black or African American`) |> arrange(desc(`Black or African American`))
```


# Explore MNPS behavior data
```{r}
# Read data
mnps_behavior_df <- read_csv("../data/MNPS Behavior Data 031025.csv")

# View summary
mnps_behavior_df |> summary()
```


```{r}
# Maybe reconcile with state and district data
mnps_behavior_df |> filter(SCHOOL == "*DISTRICT")
```


```{r}
# Numeric columns contain non-numeric values: "%", < 10", "< 5%", "> 95%"
mnps_behavior_df |> distinct(Remandment, .keep_all = TRUE)
```


# Explore MNPS attendance data
```{r}
# Read data
mnps_attendance_df <- read_csv("../data/MNPS Attendance Data 031025.csv")

# View summary
mnps_attendance_df |> summary()
```


```{r}
# Convert SchoolID to factor
mnps_attendance_df <- mnps_attendance_df |> 
    mutate(SchoolID = factor(SchoolID))
```


```{r}
# Maybe reconcile with state and district data
mnps_attendance_df |> filter(SchoolName == "*DISTRICT")
```


```{r}
# Numeric columns contain non-numeric values: "%", < 10", "< 5%"
mnps_attendance_df |> distinct(ChronicallyAbsentPercent) |> arrange(desc(ChronicallyAbsentPercent))
```


# Format column names
```{r}
# Rename tibble columns with janitor
mnps_enrollment_df <- mnps_enrollment_df |> 
    clean_names("screaming_snake")

mnps_enrollment_df |> colnames()
```


```{r}
# Rename tibble columns with janitor
mnps_behavior_df <- mnps_behavior_df |> 
    clean_names("screaming_snake")

mnps_behavior_df |> colnames()
```


```{r}
# Rename tibble columns with janitor
mnps_attendance_df <- mnps_attendance_df |> 
    clean_names("screaming_snake")

mnps_attendance_df |> colnames()
```


# Reconcile the total students
```{r}
# Verify the total number of students
enrollment_total <- mnps_enrollment_df |> 
    summarise(DISTRICT_TOTAL = sum(TOTAL_ENROLLMENT)) |> 
    pull()

enrollment_total
```


```{r}
# Verify the total number of students
behavior_total <- mnps_behavior_df |> 
    filter(SCHOOL == "*DISTRICT" & SUBGROUP == "Gender") |> 
    summarise(DISTRICT_TOTAL = sum(TOTAL_SUBGROUP_ENROLLMENT)) |> 
    pull()

behavior_total
```


```{r}
# Verify the total number of students
attendance_total <- mnps_attendance_df |> 
    filter(SCHOOL_NAME == "*DISTRICT") |> 
    select(ACTIVE_ENROLLMENT) |> 
    pull()

attendance_total
```


```{r}
# Verify the total number of students
mnps_attendance_df |> 
    filter(SCHOOL_NAME != "*DISTRICT") |> 
    summarize(TOTAL_STUDENTS = sum(ACTIVE_ENROLLMENT)) |> 
    pull()
```


# Work with MNPS behavior data
```{r}
# Clean MNPS behavior data
mnps_behavior_df <- mnps_behavior_df |> 
    # Create new columns for numeric percentages and ignore suppressed values
    mutate(SUSPENSION_PERCENT = if_else(str_detect(SUSPENSION, "<|>"), NA, SUSPENSION), .after = SUSPENSION) |> 
    mutate(EXPULSION_PERCENT = if_else(str_detect(EXPULSION, "<|>"), NA, EXPULSION), .after = EXPULSION) |> 
    mutate(REMANDMENT_PERCENT = if_else(str_detect(REMANDMENT, "<|>"), NA, REMANDMENT), .after = REMANDMENT) |>  
    # Convert the columns from char to double
    mutate(SUSPENSION_PERCENT = as.double(str_replace(SUSPENSION_PERCENT, "%", "")), .after = SUSPENSION) |>
    mutate(EXPULSION_PERCENT = as.double(str_replace(EXPULSION_PERCENT, "%", "")), .after = EXPULSION) |>
    mutate(REMANDMENT_PERCENT = as.double(str_replace(REMANDMENT_PERCENT, "%", "")), .after = REMANDMENT)
    
mnps_behavior_df
```


```{r}
# Create tibble for clean display of suspension by gender
mnps_suspension_by_gender_display_df <- mnps_behavior_df |> 
    filter(SUBGROUP == "Gender") |> 
    select(SCHOOL, TOTAL_SUBGROUP_ENROLLMENT, DATA_VALUE, SUSPENSION) |> 
    rename(TOTAL_ENROLLMENT = TOTAL_SUBGROUP_ENROLLMENT, GENDER = DATA_VALUE)

mnps_suspension_by_gender_display_df
```


```{r}
# Create tibble for plotting suspension by gender
mnps_suspension_by_gender_plot_df <- mnps_behavior_df |> 
    filter(SCHOOL == "*DISTRICT" & SUBGROUP == "Gender") |> # Filter by district totals and gender
    mutate(SUSPENSION_COUNT = round(TOTAL_SUBGROUP_ENROLLMENT * SUSPENSION_PERCENT / 100)) |> # Create column for calculated number of students suspended
    select(DATA_VALUE, TOTAL_SUBGROUP_ENROLLMENT, SUSPENSION, SUSPENSION_COUNT) |> # Narrow down necessary columns
    rename(GENDER = DATA_VALUE, TOTAL_ENROLLMENT = TOTAL_SUBGROUP_ENROLLMENT) |>  # Rename coulumns
    pivot_longer(cols = c(TOTAL_ENROLLMENT, SUSPENSION_COUNT), # Move TOTAL_ENROLLMENT and SUSPENSION_COUNT to COUNT_TYPE column
                 names_to = "COUNT_TYPE",
                 values_to = "COUNT")

mnps_suspension_by_gender_plot_df
```


```{r}
# Create plot with total students with percent of suspended students
mnps_suspension_by_gender_plot <- mnps_suspension_by_gender_plot_df |> 
    ggplot(aes(
        x = GENDER,
        y = COUNT,
        fill = COUNT_TYPE,
        label = case_match(COUNT_TYPE,
                           "SUSPENSION_COUNT" ~ SUSPENSION, # Use SUSPENSION as label for suspended students
                           "TOTAL_ENROLLMENT" ~ as.character(COUNT)) # Use COUNT as label for total students
        )) +
    # Create bar graph with info layered in front of each other
    geom_col(position = "identity") +
    # Update the plot labels
    labs(title = "Suspension by Gender",
         subtitle = "MNPS District",
         x = "Gender",
         y = "Number of Students",
         fill = NULL) +
    scale_y_continuous(labels = label_comma()) +
    scale_fill_hue(labels = c("SUSPENSION_COUNT" = "Suspended Students",
                               "TOTAL_ENROLLMENT" = "Total Students"),
                    guide = guide_legend(reverse = TRUE)) + # Reverse order of legend labels
    # Display geom labels
    geom_label(colour = "white",
               fontface = "bold",
               key_glyph = draw_key_rect)

mnps_suspension_by_gender_plot
```


```{r}
# Save the plot
ggsave(filename = "../plots/mnps_suspension_by_gender_plot.png", # Set path
       plot = mnps_suspension_by_gender_plot, # Select plot
       width = 5, # Set width
       height = 4, # Set height
       dpi = 300) # Set resolution
```


# Work with state chronic absenteeism data
```{r}
state_chronically_absent_by_gender_plot <- state_chronic_absenteeism_suppressed_df |> 
    clean_names("screaming_snake") |> 
    filter(STUDENT_GROUP %in% c("Male", "Female")) |> 
    pivot_longer(
        cols = c(N_STUDENTS, N_CHRONICALLY_ABSENT),
        names_to = "COUNT_TYPE",
        values_to = "COUNT"
    ) |> 
    select(STUDENT_GROUP, GRADE_BAND, COUNT_TYPE, COUNT, PCT_CHRONICALLY_ABSENT) |> 
    ggplot(
        aes(
            x = factor(GRADE_BAND, levels = c("All Grades", "K through 8th", "9th through 12th")),
            y = COUNT,
            fill = COUNT_TYPE,
            label = case_match(
                COUNT_TYPE,
                "N_CHRONICALLY_ABSENT" ~ str_c(as.character(PCT_CHRONICALLY_ABSENT), "%"),
                "N_STUDENTS" ~ as.character(COUNT)
            )
        )
    ) +
    geom_col(position = "identity") +
    facet_wrap(vars(STUDENT_GROUP)) +
    labs(
        title = "Chronically Absent by Gender",
        subtitle = "State of TN",
        x = "Grade",
        y = "Number of Students",
        fill = NULL
    ) +
    scale_y_continuous(labels = label_comma()) +
    scale_x_discrete(guide = guide_axis(angle = 45)) +
    scale_fill_hue(
        labels = c("N_CHRONICALLY_ABSENT" = "Chronically Absent",
                   "N_STUDENTS" = "Total Students"),
        guide = guide_legend(reverse = TRUE)
    ) +
    geom_label(
        colour = "white",
        fontface = "bold",
        key_glyph = draw_key_rect
    )

state_chronically_absent_by_gender_plot
```


```{r}
# Save the plot
ggsave(filename = "../plots/state_chronically_absent_by_gender_plot.png", # Set path
       plot = state_chronically_absent_by_gender_plot, # Select plot
       width = 6, # Set width
       height = 4, # Set height
       dpi = 300) # Set resolution
```
---
title: "data_exploration"
output: html_document
---


```{r}
library(tidyverse)
library(janitor) # Cleans names of a data.frame
library(scales) # Graphical scales for plots
```


# Read and explore TN data
```{r}
district_profile_df <- read_csv("../data/district-profile-2024-2025.csv") |> 
    clean_names("screaming_snake")

district_profile_df |> summary()
```


```{r}
district_profile_df <- district_profile_df |> 
    mutate(DISTRICT_NO = factor(DISTRICT_NO))
```


```{r}
district_profile_df |> distinct(DISTRICT_NO)
```


```{r}
district_profile_df |> filter(DISTRICT_NO == 0)
```


```{r}
# Percentage columns contain non-numeric values: "Less than 1%", "Fewer than 10 students", "More than 99%"
district_profile_df |> distinct(HAWAIIAN_PACISLD_PCT) |> arrange(HAWAIIAN_PACISLD_PCT)
```


```{r}
school_profile_df <- read_csv("../data/school-profile-2024-2025.csv") |> 
    clean_names("screaming_snake")

school_profile_df |> summary()
```


```{r}
school_profile_df <- school_profile_df |> 
    mutate(DISTRICT_NO = factor(DISTRICT_NO)) |> 
    mutate(SCHOOL_NO = factor(SCHOOL_NO))
```


```{r}
# Percentage columns contain non-numeric values: "Less than 5%", "Fewer than 10 students", "More than 95%"
school_profile_df |> distinct(WHITE_PCT) |> arrange(desc(WHITE_PCT))
```


```{r}
district_discipline_df <- read_csv("../data/discipline-district-2425.csv") |> 
    clean_names("screaming_snake")

district_discipline_df |> summary()
```


```{r}
district_discipline_df <- district_discipline_df |> 
    mutate(DISTRICT = factor(DISTRICT))
```


```{r}
# Count and percent columns contain non-numeric values: "Less than 1%", "Fewer than 10 students"
district_discipline_df |> distinct(STUDENTS_ISS) |> arrange(desc(STUDENTS_ISS))
```


```{r}
school_discipline_df <- read_csv("../data/discipline-school-2425.csv") |> 
    clean_names("screaming_snake")

school_discipline_df |> summary()
```


```{r}
school_discipline_df <- school_discipline_df |> 
    mutate(DISTRICT = factor(DISTRICT)) |> 
    mutate(SCHOOL = factor(SCHOOL))
```


```{r}
# Does not contain district 0 for State of TN
# Duplicates in School and School Name (separate districts)
# Count and percent columns contain non-numeric values: "Fewer than 10 students", "Less than 1%", "Less than 5%"
school_discipline_df |> distinct(PERCENT_DISCIPLINED) |> arrange(desc(PERCENT_DISCIPLINED))
```


```{r}
state_chronic_absenteeism_suppressed_df <- read_csv("../data/state_chronic_absenteeism_suppressed_2025.csv") |> 
    clean_names("screaming_snake")

state_chronic_absenteeism_suppressed_df |> summary()
```


```{r}
# No non-numeric values in count or percentage columns
state_chronic_absenteeism_suppressed_df |> distinct(N_CHRONICALLY_ABSENT) |> arrange(N_CHRONICALLY_ABSENT)
```


```{r}
district_chronic_absenteeism_suppressed_df <- read_csv("../data/district_chronic_absenteeism_suppressed_2025.csv") |> 
    clean_names("screaming_snake")

district_chronic_absenteeism_suppressed_df |> summary()
```


```{r}
district_chronic_absenteeism_suppressed_df <- district_chronic_absenteeism_suppressed_df |> 
    mutate(SYSTEM = factor(SYSTEM))
```


```{r}
# I think "system" is the same as "district"
# n_chronically_absent and pct_chronically_absent contains non-numeric values: "<10 students", "<1%"
district_chronic_absenteeism_suppressed_df |> distinct(PCT_CHRONICALLY_ABSENT) |> arrange(desc(PCT_CHRONICALLY_ABSENT))
```


```{r}
school_chronic_absenteeism_suppressed_df <- read_csv("../data/school_chronic_absenteeism_suppressed_2025.csv") |> 
    clean_names("screaming_snake")

school_chronic_absenteeism_suppressed_df |> summary()
```


```{r}
school_chronic_absenteeism_suppressed_df <- school_chronic_absenteeism_suppressed_df |> 
    mutate(system = factor(SYSTEM)) |> 
    mutate(system = factor(SCHOOL))
```


```{r}
# I think "system" is the same as "district"
# n_chronically_absent contains non-numeric values: "<10 students", "<5%", ">95%"
school_chronic_absenteeism_suppressed_df |> distinct(N_CHRONICALLY_ABSENT) |> arrange(desc(N_CHRONICALLY_ABSENT))
```


# Read and explore MNPS data
```{r}
mnps_enrollment_df <- read_csv("../data/MNPS Enrollment Data 031025.csv") |> 
    clean_names("screaming_snake")

mnps_enrollment_df |> summary()
```


```{r}
mnps_enrollment_df
```



```{r}
mnps_enrollment_df <- mnps_enrollment_df |> 
    mutate(SCHOOL_ID = factor(SCHOOL_ID)) |> 
    mutate(ZIP_CODE = factor(ZIP_CODE))
```


```{r}
# Ignore `School Level` value "Adult"? Verify 149 districts
mnps_enrollment_df |> distinct(SCHOOL_LEVEL) |> arrange(desc(SCHOOL_LEVEL))
```


```{r}
# Grade columns contains non-numeric values: "%", "< 10", "< 5%", "> 95%"
mnps_enrollment_df |> distinct(BLACK_OR_AFRICAN_AMERICAN) |> arrange(desc(BLACK_OR_AFRICAN_AMERICAN))
```


```{r}
mnps_behavior_df <- read_csv("../data/MNPS Behavior Data 031025.csv") |> 
    clean_names("screaming_snake")

mnps_behavior_df |> summary()
```


```{r}
# Maybe reconcile with state and district data
mnps_behavior_df |> filter(SCHOOL == "*DISTRICT")
```


```{r}
# Numeric columns contain non-numeric values: "%", < 10", "< 5%", "> 95%"
mnps_behavior_df |> distinct(REMANDMENT, .keep_all = TRUE)
```


```{r}
mnps_attendance_df <- read_csv("../data/MNPS Attendance Data 031025.csv") |> 
    clean_names("screaming_snake")

mnps_attendance_df |> summary()
```


```{r}
mnps_attendance_df <- mnps_attendance_df |> 
    mutate(SCHOOL_ID = factor(SCHOOL_ID))
```


```{r}
mnps_attendance_df |> filter(SCHOOL_NAME == "*DISTRICT")
```


```{r}
# Numeric columns contain non-numeric values: "%", < 10", "< 5%"
mnps_attendance_df |> distinct(CHRONICALLY_ABSENT_PERCENT) |> arrange(desc(CHRONICALLY_ABSENT_PERCENT))
```


# Reconcile the total students
```{r}
enrollment_total <- mnps_enrollment_df |> 
    summarise(DISTRICT_TOTAL = sum(TOTAL_ENROLLMENT)) |> 
    pull()

enrollment_total
```


```{r}
behavior_total <- mnps_behavior_df |> 
    filter(SCHOOL == "*DISTRICT" & SUBGROUP == "Gender") |> 
    summarise(DISTRICT_TOTAL = sum(TOTAL_SUBGROUP_ENROLLMENT)) |> 
    pull()

behavior_total
```


```{r}
attendance_total <- mnps_attendance_df |> 
    filter(SCHOOL_NAME == "*DISTRICT") |> 
    select(ACTIVE_ENROLLMENT) |> 
    pull()

attendance_total
```


# Analysis on MNPS behavior data
```{r}
mnps_behavior_df <- mnps_behavior_df |> 
    # Create new columns for numeric percentages and ignore suppressed values
    mutate(SUSPENSION_PERCENT = if_else(str_detect(SUSPENSION, "<|>"), NA, SUSPENSION), .after = SUSPENSION) |> 
    mutate(EXPULSION_PERCENT = if_else(str_detect(EXPULSION, "<|>"), NA, EXPULSION), .after = EXPULSION) |> 
    mutate(REMANDMENT_PERCENT = if_else(str_detect(REMANDMENT, "<|>"), NA, REMANDMENT), .after = REMANDMENT) |>  
    # Convert the columns from char to double
    mutate(SUSPENSION_PERCENT = as.double(str_replace(SUSPENSION_PERCENT, "%", "")), .after = SUSPENSION) |>
    mutate(EXPULSION_PERCENT = as.double(str_replace(EXPULSION_PERCENT, "%", "")), .after = EXPULSION) |>
    mutate(REMANDMENT_PERCENT = as.double(str_replace(REMANDMENT_PERCENT, "%", "")), .after = REMANDMENT)
    
mnps_behavior_df |> head(5)
```


```{r}
# Create tibble for clean display of suspension by gender
mnps_suspension_by_gender_display_df <- mnps_behavior_df |> 
    filter(SCHOOL != "*DISTRICT" & SUBGROUP == "Gender")

mnps_suspension_by_gender_display_df |> head(5)
```


```{r}
# Logistic regression: suspension percent is not statistically significant
mnps_gender_suspension_model <- glm(factor(DATA_VALUE) ~ SUSPENSION_PERCENT, data = mnps_suspension_by_gender_display_df, family = "binomial")

summary(mnps_gender_suspension_model)
```


```{r}
# Create tibble for paired t-test
mnps_suspend_gender_paired_df <- mnps_suspension_by_gender_display_df |> 
    select(SCHOOL, DATA_VALUE, SUSPENSION_PERCENT) |> 
    pivot_wider(
        names_from = DATA_VALUE,
        values_from = SUSPENSION_PERCENT
    )

mnps_suspend_gender_paired_df |> head(5)
```


```{r}
# t-test: suspension percent is statistically significant
t.test(
    x = mnps_suspend_gender_paired_df$MALE,
    y = mnps_suspend_gender_paired_df$FEMALE,
    paired = TRUE
)
```


```{r}
mnps_suspension_by_gender_df <- mnps_behavior_df |> 
    filter(SCHOOL != "*DISTRICT" & SUBGROUP == "Gender") |>
    mutate(SUSPENSION_COUNT = round(TOTAL_SUBGROUP_ENROLLMENT * SUSPENSION_PERCENT / 100)) |>
    select(SCHOOL, DATA_VALUE, TOTAL_SUBGROUP_ENROLLMENT, SUSPENSION, SUSPENSION_COUNT) |>
    rename(
        GENDER = DATA_VALUE,
        TOTAL_ENROLLMENT = TOTAL_SUBGROUP_ENROLLMENT
    )
    
mnps_suspension_by_gender_df |> head(5)
```


```{r}
# Experiment with cbind
t.test(cbind(SUSPENSION_COUNT, TOTAL_ENROLLMENT - SUSPENSION_COUNT) ~ GENDER, data = mnps_suspension_by_gender_df)
```


```{r}
mnps_suspension_by_gender_plot <- mnps_behavior_df |> 
    # Create tibble for suspension by gender
    filter(SCHOOL == "*DISTRICT" & SUBGROUP == "Gender") |>
    # Create column for calculated number of students suspended
    mutate(SUSPENSION_COUNT = round(TOTAL_SUBGROUP_ENROLLMENT * SUSPENSION_PERCENT / 100)) |>
    select(DATA_VALUE, TOTAL_SUBGROUP_ENROLLMENT, SUSPENSION, SUSPENSION_COUNT) |>
    rename(
        GENDER = DATA_VALUE,
        TOTAL_ENROLLMENT = TOTAL_SUBGROUP_ENROLLMENT
    ) |>
    # Move TOTAL_ENROLLMENT and SUSPENSION_COUNT to COUNT_TYPE column
    pivot_longer(
        cols = c(TOTAL_ENROLLMENT, SUSPENSION_COUNT),
        names_to = "COUNT_TYPE",
        values_to = "COUNT"
    ) |> 
    # Create a plot
    ggplot(
        aes(
            x = GENDER,
            y = COUNT,
            fill = COUNT_TYPE,
            label = case_match(
                COUNT_TYPE,
                "SUSPENSION_COUNT" ~ SUSPENSION,
                "TOTAL_ENROLLMENT" ~ as.character(COUNT)
            )
        )
    ) +
    # Create bar graph with info layered in front of each other
    geom_col(position = "identity") +
    # Format labels
    labs(
        title = "Suspension by Gender",
        subtitle = "MNPS District",
        x = "Gender",
        y = "Number of Students",
        fill = NULL
    ) +
    # Format y-axis ticks
    scale_y_continuous(labels = label_comma()) +
    # Format fill
    scale_fill_hue(
        labels = c("SUSPENSION_COUNT" = "Suspended Students", "TOTAL_ENROLLMENT" = "Total Students"),
        guide = guide_legend(reverse = TRUE)
    ) +
    # Format legend labels
    geom_label(
        colour = "white",
        fontface = "bold",
        key_glyph = draw_key_rect
    )

mnps_suspension_by_gender_plot
```


```{r}
# Save the plot
ggsave(
    filename = "../plots/mnps_suspension_by_gender_plot.png",
    plot = mnps_suspension_by_gender_plot,
    width = 5,
    height = 4,
    dpi = 100
)
```


```{r}
mnps_suspension_by_gender_box_plot <- mnps_behavior_df |> 
    # Create tibble for suspension by gender
    filter(SUBGROUP == "Gender") |>
    # Create column for calculated number of students suspended
    rename(GENDER = DATA_VALUE) |>
    # Create a plot
    ggplot(
        aes(
            x = GENDER,
            y = SUSPENSION_PERCENT,
            color = GENDER
        )
    ) +
    # Create boxplot
    geom_boxplot() +
    # Format labels
    labs(
        title = "Suspension by Gender",
        subtitle = "MNPS District",
        x = "Gender",
        y = "Suspension Percent",
        color = NULL
    )

mnps_suspension_by_gender_box_plot
```


```{r}
# Save the plot
ggsave(
    filename = "../plots/mnps_suspension_by_gender_box_plot.png",
    plot = mnps_suspension_by_gender_box_plot,
    width = 4,
    height = 4,
    dpi = 100
)
```


# Analysis on MNPS attendance data
```{r}
# Merge gender data with attendance
# Cannot determine absent rates by gender
mnps_attendance_df |> 
    inner_join(
        mnps_enrollment_df,
        by = join_by(SCHOOL_NAME == SCHOOL_NAME, DATA_AS_OF)
    ) |> 
    select(SCHOOL_NAME, ACTIVE_ENROLLMENT, MALE, FEMALE, CHRONICALLY_ABSENT_COUNT, CHRONICALLY_ABSENT_PERCENT)
```


# Analysis on state chronic absenteeism data
```{r}
state_chronic_absenteeism_suppressed_df |> 
    filter(STUDENT_GROUP %in% c("Male", "Female") & GRADE_BAND == "All Grades")
```



```{r}
state_chronically_absent_by_gender_plot <- state_chronic_absenteeism_suppressed_df |> 
    # Create a tibble for state absent by gender
    filter(STUDENT_GROUP %in% c("Male", "Female")) |> 
    pivot_longer(
        cols = c(N_STUDENTS, N_CHRONICALLY_ABSENT),
        names_to = "COUNT_TYPE",
        values_to = "COUNT"
    ) |> 
    select(STUDENT_GROUP, GRADE_BAND, COUNT_TYPE, COUNT, PCT_CHRONICALLY_ABSENT) |> 
    # Create a plot
    ggplot(
        aes(
            x = factor(GRADE_BAND, levels = c("All Grades", "K through 8th", "9th through 12th")),
            y = COUNT,
            fill = COUNT_TYPE,
            label = case_match(
                COUNT_TYPE,
                "N_CHRONICALLY_ABSENT" ~ str_c(as.character(PCT_CHRONICALLY_ABSENT), "%"),
                "N_STUDENTS" ~ as.character(COUNT)
            )
        )
    ) +
    # Create bar graph with info layered in front of each other
    geom_col(position = "identity") +
    # Create facet wrap
    facet_wrap(vars(STUDENT_GROUP)) +
    # Format labels
    labs(
        title = "Chronically Absent by Gender",
        subtitle = "State of TN",
        x = "Grade",
        y = "Number of Students",
        fill = NULL
    ) +
    # Format y-axis ticks
    scale_y_continuous(labels = label_comma()) +
    # Format x-axis ticks
    scale_x_discrete(guide = guide_axis(angle = 45)) +
    # Format fill
    scale_fill_hue(
        labels = c("N_CHRONICALLY_ABSENT" = "Chronically Absent", "N_STUDENTS" = "Total Students"),
        guide = guide_legend(reverse = TRUE)
    ) +
    # Format legend
    geom_label(
        colour = "white",
        fontface = "bold",
        key_glyph = draw_key_rect
    )

state_chronically_absent_by_gender_plot
```


```{r}
# Save the plot
ggsave(
    filename = "../plots/state_chronically_absent_by_gender_plot.png",
    plot = state_chronically_absent_by_gender_plot,
    width = 7,
    height = 4,
    dpi = 100
)
```


# Analysis on district chronic absenteeism data
```{r}
# UNUSABLE GRAPH
district_chronically_absent_by_gender_plot <- district_chronic_absenteeism_suppressed_df |> 
    # Create tibble for district absent by gender
    filter(STUDENT_GROUP %in% c("Male", "Female") & GRADE_BAND == "All Grades") |> 
    mutate(
        CHRONICALLY_ABSENT_COUNT = if_else(
            str_detect(N_CHRONICALLY_ABSENT, "<|>"),
            NA,
            as.double(N_CHRONICALLY_ABSENT
            )
        ),
        .after = N_CHRONICALLY_ABSENT
    ) |> 
    mutate(
        CHRONICALLY_ABSENT_PERCENT = if_else(
            str_detect(PCT_CHRONICALLY_ABSENT, "<|>"),
            NA,
            as.double(PCT_CHRONICALLY_ABSENT
            )
        ),
        .after = PCT_CHRONICALLY_ABSENT
    ) |>
    pivot_longer(
        cols = c(N_STUDENTS, CHRONICALLY_ABSENT_COUNT),
        names_to = "COUNT_TYPE",
        values_to = "COUNT"
    ) |>
    select(SYSTEM_NAME, STUDENT_GROUP, COUNT_TYPE, COUNT, PCT_CHRONICALLY_ABSENT, CHRONICALLY_ABSENT_PERCENT) |>
    # Create plot
    ggplot(
        aes(
            x = COUNT,
            y = SYSTEM_NAME,
            fill = COUNT_TYPE,
            label = case_match(
                COUNT_TYPE,
                "CHRONICALLY_ABSENT_COUNT" ~ str_c(as.character(CHRONICALLY_ABSENT_PERCENT), "%"),
                "N_STUDENTS" ~ as.character(COUNT)
            )
        )
    ) +
    # Create bar graph
    geom_col(position = "identity") +
    # Create facet wrap
    facet_wrap(vars(STUDENT_GROUP)) +
    # Format labels
    labs(
        title = "Chronically Absent by Gender",
        subtitle = "Districts",
        x = "Number of Students",
        y = "Districts",
        fill = NULL
    ) +
    # Format y-axis ticks
    scale_y_discrete(limits = rev) +
    # Format x-axis ticks
    scale_x_continuous(labels = label_comma(), guide = guide_axis(angle = 45)) +
    # Format fill
    scale_fill_hue(
        labels = c("CHRONICALLY_ABSENT_COUNT" = "Chronically Absent", "N_STUDENTS" = "Total Students"),
        guide = guide_legend(reverse = TRUE)
    ) +
    # Format legend
    geom_label(
        colour = "white",
        fontface = "bold",
        key_glyph = draw_key_rect,
        position = position_dodge(width = 2),
        hjust = -1
    )

district_chronically_absent_by_gender_plot
```


```{r}
# Save the plot
ggsave(
    filename = "../plots/district_chronically_absent_by_gender_plot.png",
    plot = district_chronically_absent_by_gender_plot,
    width = 15,
    height = 45,
    dpi = 100
)
```


# Group data by region
```{r}
region_df <- bind_rows(
    list(
        read_csv("../data/tnsd_east_region.csv"),
        read_csv("../data/tnsd_first_region.csv"),
        read_csv("../data/tnsd_midcumberland_region.csv"),
        read_csv("../data/tnsd_northwest_region.csv"),
        read_csv("../data/tnsd_southcentral_region.csv"),
        read_csv("../data/tnsd_southeast_region.csv"),
        read_csv("../data/tnsd_southwest_region.csv"),
        read_csv("../data/tnsd_uppercumberland_region.csv")
    )
) |> clean_names("screaming_snake")

region_df
```

# CHECK FEMALE NORTHWEST TENNESSEE REGION
```{r}
# Merge district absenteeism with region data
region_district_absenteeism_df <- district_chronic_absenteeism_suppressed_df |> 
    left_join(
        region_df |> select(DISTRICT, REGION_NAME) |> distinct(DISTRICT, .keep_all = TRUE),
        by = join_by(SYSTEM_NAME == DISTRICT)
    )

region_district_absenteeism_df
```


```{r}
region_district_absenteeism_df |> 
    filter(!is.na(REGION_NAME) & STUDENT_GROUP %in% c("Male", "Female") & GRADE_BAND == "All Grades") |> 
    select(REGION_NAME, SYSTEM_NAME, STUDENT_GROUP, PCT_CHRONICALLY_ABSENT) |> 
    pivot_wider(
        names_from = STUDENT_GROUP,
        values_from = PCT_CHRONICALLY_ABSENT
    ) |> 
    drop_na()
    
```



```{r}
# Plot region chronic absenteeism by gender
region_district_absenteeism_plot <- region_district_absenteeism_df |> 
    mutate(
        ABSENT_COUNT = if_else(
            str_detect(N_CHRONICALLY_ABSENT, "<|>"),
            NA,
            as.double(N_CHRONICALLY_ABSENT)
        ),
        .after = N_CHRONICALLY_ABSENT
    ) |>
    filter(!is.na(REGION_NAME) & STUDENT_GROUP %in% c("Male", "Female") & GRADE_BAND == "All Grades") |>
    select(REGION_NAME, SYSTEM_NAME, STUDENT_GROUP, N_STUDENTS, ABSENT_COUNT) |> 
    group_by(REGION_NAME, STUDENT_GROUP) |>
    summarize(
        SUM_STUDENT_COUNT = sum(N_STUDENTS),
        SUM_ABSENT_COUNT = sum(ABSENT_COUNT)
    ) |> 
    mutate(ABSENT_PERCENT = round((SUM_ABSENT_COUNT / SUM_STUDENT_COUNT * 100), digits = 1)) |> 
    pivot_longer(
        cols = c(SUM_STUDENT_COUNT, SUM_ABSENT_COUNT),
        names_to = "COUNT_TYPE",
        values_to = "COUNT"
    ) |>
    ggplot(
        aes(
            x = REGION_NAME,
            y = COUNT,
            fill = COUNT_TYPE,
            label = case_match(
                COUNT_TYPE,
                "SUM_ABSENT_COUNT" ~ str_c(as.character(ABSENT_PERCENT), "%"),
                "SUM_STUDENT_COUNT" ~ as.character(COUNT)
            )
        )
    ) +
    geom_col(position = "identity") +
    facet_grid(rows = vars(STUDENT_GROUP)) +
    labs(
        title = "Chronically Absent by Gender",
        subtitle = "Divided by Region",
        x = "Regions",
        y = "Number of Students",
        fill = NULL
    ) +
    scale_x_discrete(guide = guide_axis(angle = 45), limits = rev) +
    scale_y_continuous(labels = label_comma()) +
    scale_fill_hue(
        labels = c("SUM_ABSENT_COUNT" = "Chronically Absent",
                   "SUM_STUDENT_COUNT" = "Total Students"),
        guide = guide_legend(reverse = TRUE)
    ) +
    geom_label(
        colour = "white",
        fontface = "bold",
        key_glyph = draw_key_rect
    )

region_district_absenteeism_plot
```


```{r}
# Save the plot
ggsave(
    filename = "../plots/region_district_absenteeism_plot.png",
    plot = region_district_absenteeism_plot,
    width = 10,
    height = 10,
    dpi = 100
)
```


# Analysis on school chronic absenteeism data
```{r}
# Clean tibble to model data
school_absent_df <- school_chronic_absenteeism_suppressed_df |> 
    mutate(
        ABSENT_COUNT = if_else(
            str_detect(N_CHRONICALLY_ABSENT, "<|>"),
            NA,
            as.double(N_CHRONICALLY_ABSENT)
        ),
        .after = N_CHRONICALLY_ABSENT
    ) |> 
    mutate(
        ABSENT_PERCENT = if_else(
            str_detect(PCT_CHRONICALLY_ABSENT, "<|>"),
            NA,
            as.double(PCT_CHRONICALLY_ABSENT)
        ),
        .after = PCT_CHRONICALLY_ABSENT
    ) |> 
    filter(STUDENT_GROUP %in% c("Male", "Female")) |> 
    select(SYSTEM_NAME, SCHOOL_NAME, STUDENT_GROUP, N_STUDENTS, ABSENT_COUNT, ABSENT_PERCENT)

school_absent_df |> head(5)
```


```{r}
# Logistic regression: absent percent is not statistically significant
school_absent_model <- glm(factor(STUDENT_GROUP) ~ ABSENT_PERCENT, data = school_absent_df, family = "binomial")

summary(school_absent_model)
```


```{r}
school_absent_df |> 
    ggplot(aes(x = N_STUDENTS, y = ABSENT_PERCENT, color = STUDENT_GROUP)) +
    geom_point()
```


```{r}
# Merge school absenteeism with region data
region_school_absenteeism_df <- school_absent_df |> 
    left_join(
        region_df |> select(DISTRICT, REGION_NAME) |> distinct(DISTRICT, .keep_all = TRUE),
        by = join_by(SYSTEM_NAME == DISTRICT)
    )

region_school_absenteeism_df |> filter(REGION_NAME == "Northwest Tennessee")
```


```{r}
region_school_absenteeism_df |> filter(is.na(ABSENT_COUNT))
```


```{r}
# Logistic regression: region name is not statistically significant
school_absent_region_model <- glm(factor(STUDENT_GROUP) ~ ABSENT_PERCENT + REGION_NAME, data = region_school_absenteeism_df, family = "binomial")

summary(school_absent_region_model)
```


```{r}
# Linear regression: may be statistically significant
school_absent_region_linear = lm(ABSENT_PERCENT ~ STUDENT_GROUP + REGION_NAME, data = region_school_absenteeism_df)

school_absent_region_linear |> summary()
```


```{r}
region_school_absenteeism_plot <- region_school_absenteeism_df |> 
    ggplot(aes(x = N_STUDENTS, y = ABSENT_PERCENT, color = STUDENT_GROUP, apha = 0.5)) +
    geom_point(position = position_jitter()) +
    facet_grid(rows = vars(REGION_NAME))

region_school_absenteeism_plot
```


```{r}
# Save the plot
ggsave(
    filename = "../plots/region_school_absenteeism_plot.png",
    plot = region_school_absenteeism_plot,
    width = 10,
    height = 10,
    dpi = 100
)
```


```{r}
region_school_absenteeism_df |> 
    ggplot(aes(x = ABSENT_PERCENT, y = N_STUDENTS, color = STUDENT_GROUP, apla = 0.5)) +
    geom_point() +
    facet_wrap(vars(STUDENT_GROUP))
```


```{r}
region_school_absenteeism_df |> 
    ggplot(aes(x = ABSENT_PERCENT, y = N_STUDENTS, color = STUDENT_GROUP, alpha = 0.5)) +
    geom_point() +
    facet_wrap(vars(STUDENT_GROUP)) +
    scale_y_log10() +
    scale_x_log10()
```


```{r}
# Linear regression: 
lm(ABSENT_PERCENT ~  N_STUDENTS, data = region_school_absenteeism_df) |> summary()
```


# Work with MNPS absenteesim data
```{r}
mnps_absent_df <- mnps_enrollment_df |>
    select(SCHOOL_NAME) |>
    left_join(
        school_absent_df,
        by = join_by(SCHOOL_NAME == SCHOOL_NAME)
    ) |> 
    filter(SYSTEM_NAME == "Davidson County")

mnps_absent_df
```


```{r}
mnps_absent_df |> 
    group_by(STUDENT_GROUP) |> 
    summarize(sum(ABSENT_COUNT, na.rm = TRUE), sum(N_STUDENTS, na.rm = TRUE))
```


```{r}
mnps_absent_gender_model <- glm(cbind(ABSENT_COUNT, N_STUDENTS - ABSENT_COUNT) ~ STUDENT_GROUP, data = mnps_absent_df, family = "binomial")

summary(mnps_absent_gender_model)
```



```{r}
mnps_gender_absent_model <- glm(factor(STUDENT_GROUP) ~ ABSENT_PERCENT, data = mnps_absent_df, family = "binomial")

summary(mnps_gender_absent_model)
```


```{r}
mnps_absent_gender_model <- lm(ABSENT_PERCENT ~ STUDENT_GROUP, data = mnps_absent_df)

summary(mnps_absent_gender_model)
```


```{r}
mnps_absent_point_plot <- mnps_absent_df |> 
    ggplot(aes(x = ABSENT_PERCENT, y = N_STUDENTS, color = STUDENT_GROUP)) +
    geom_point() +
    labs(title = "Chronic Absenteeism by Gender",
         subtitle = "MNPS District",
         x = "Absent Percentage",
         y = "Total Students Per School",
         color = NULL)

mnps_absent_point_plot
```


```{r}
# Save the plot
ggsave(
    filename = "../plots/mnps_absent_point_plot.png",
    plot = mnps_absent_point_plot,
    width = 5,
    height = 4,
    dpi = 100
)
```


```{r}
mnps_absent_box_plot <- mnps_absent_df |> 
    ggplot(aes(x = STUDENT_GROUP, y = ABSENT_PERCENT, color = STUDENT_GROUP)) +
    geom_boxplot() +
    labs(title = "Chronic Absenteeism by Gender",
         subtitle = "MNPS District",
         x = "Gender",
         y = "Absent Percentage",
         color = NULL)

mnps_absent_box_plot
```


```{r}
# Save the plot
ggsave(
    filename = "../plots/mnps_absent_box_plot.png",
    plot = mnps_absent_box_plot,
    width = 4,
    height = 5,
    dpi = 100
)
```


```{r}
mnps_absent_df |> 
    summarise(
        correlation = cor(N_STUDENTS, ABSENT_PERCENT, use = "complete.obs")
    )
```


```{r}
mnps_absent_df |> 
    mutate(STUDENT_GROUP_BI = if_else(STUDENT_GROUP == "Male", 0, 1)) |> 
    summarise(
        correlation = cor(STUDENT_GROUP_BI, ABSENT_PERCENT, use = "complete.obs")
    )
```


```{r}
school_absent_df |> 
    summarise(
        correlation = cor(N_STUDENTS, ABSENT_PERCENT, use = "complete.obs")
    )
```


```{r}
mnps_absent_gender_paired_df <- mnps_absent_df |> 
    distinct(SCHOOL_NAME, STUDENT_GROUP, .keep_all = TRUE) |> 
    select(SCHOOL_NAME, STUDENT_GROUP, ABSENT_PERCENT) |>
    pivot_wider(
        names_from = STUDENT_GROUP,
        values_from = ABSENT_PERCENT
    )

mnps_absent_gender_paired_df
```


```{r}
t.test(
    x = mnps_absent_gender_paired_df$Male,
    y = mnps_absent_gender_paired_df$Female,
    paired = TRUE
)
```


```{r}
mnps_absent_plot <- mnps_absent_df |>
    group_by(STUDENT_GROUP) |> 
    summarise(
        TOTAL_STUDENTS = sum(N_STUDENTS),
        TOTAL_ABSENT = sum(ABSENT_COUNT, na.rm = TRUE)
    ) |> 
    mutate(ABSENT_PERCENT = str_c(as.character(round(TOTAL_ABSENT / TOTAL_STUDENTS * 100, digit = 1)), "%")) |> 
    pivot_longer(
        cols = c(TOTAL_STUDENTS, TOTAL_ABSENT),
        names_to = "COUNT_TYPE",
        values_to = "COUNT"
    ) |> 
    ggplot(
        aes(
            x = STUDENT_GROUP,
            y = COUNT,
            fill = COUNT_TYPE,
            label = case_match(COUNT_TYPE,
                               "TOTAL_ABSENT" ~ ABSENT_PERCENT,
                               "TOTAL_STUDENTS" ~ as.character(COUNT))
        )
    ) +
    geom_col(position = "identity") +
    labs(title = "Chronic Absenteeism by Gender",
         subtitle = "MNPS District",
         x = "Gender",
         y = "Number of Students",
         fill = NULL) +
    scale_fill_hue(labels = c("TOTAL_ABSENT" = "Absent Students",
                              "TOTAL_STUDENTS" = "Total Students"),
                   # Reverse order of legend labels
                   guide = guide_legend(reverse = TRUE)) +
    # Display geom labels
    geom_label(colour = "white",
               fontface = "bold",
               key_glyph = draw_key_rect)

mnps_absent_plot
```


```{r}
# Save the plot
ggsave(
    filename = "../plots/mnps_absent_plot.png",
    plot = mnps_absent_plot,
    width = 5,
    height = 4,
    dpi = 100
)
```


```{r}
mnps_absent_df |> 
    group_by(STUDENT_GROUP) |> 
    summarise(
        N_STUDENTS = sum(N_STUDENTS),
        ABSENT_COUNT = sum(ABSENT_COUNT, na.rm = TRUE)
    ) |> 
    mutate(SCHOOL_NAME = "*DISTRICT") |>
    mutate(ABSENT_PERCENT = round(ABSENT_COUNT / N_STUDENTS * 100, digit = 1)) |>
    full_join(
        mnps_absent_df
    )
```

